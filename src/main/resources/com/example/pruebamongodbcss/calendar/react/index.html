<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Citas</title>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- FullCalendar Core -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    
    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        #calendar-container {
            display: flex;
            height: 100vh;
        }
        
        #sidebar {
            width: 250px;
            padding: 20px;
            background-color: var(--calendar-bg);
            border-right: 1px solid var(--border-color);
        }
        
        #calendar-main {
            flex-grow: 1;
            padding: 20px;
        }
        
        #calendar {
            height: 100%;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-item {
            margin-bottom: 8px;
        }
        
        .sidebar-actions {
            margin-top: 20px;
        }
        
        .action-button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background-color: var(--button-bg);
            color: var(--button-text);
            cursor: pointer;
        }
        
        .action-button:hover {
            background-color: var(--button-hover);
        }
    </style>
</head>
<body>
    <div id="calendar-container">
        <div id="sidebar">
            <h3>Filtros</h3>
            <div class="filter-section">
                <div class="filter-title">Tipos de citas</div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-normal" checked>
                    <label for="filter-normal">Normales</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-urgent" checked>
                    <label for="filter-urgent">Urgentes</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-completed" checked>
                    <label for="filter-completed">Completadas</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-cancelled" checked>
                    <label for="filter-cancelled">Canceladas</label>
                </div>
            </div>
            
            <div class="sidebar-actions">
                <button id="btn-today" class="action-button">
                    <i class="material-icons">today</i> Hoy
                </button>
                <button id="btn-refresh" class="action-button">
                    <i class="material-icons">refresh</i> Actualizar
                </button>
                <button id="btn-new-event" class="action-button">
                    <i class="material-icons">add</i> Nueva cita
                </button>
                <button id="btn-print" class="action-button">
                    <i class="material-icons">print</i> Imprimir
                </button>
            </div>
        </div>
        <div id="calendar-main">
            <div id="calendar"></div>
        </div>
    </div>

    <script>
        // Variable para el calendario
        let calendar;
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, FullCalendar disponible:', typeof FullCalendar !== 'undefined');
            
            // Inicializar el calendario
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: [
                    'dayGrid', 'timeGrid', 'interaction'
                ],
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [
                    {
                        id: '1',
                        title: 'Revisión de Max (María García)',
                        start: '2023-05-16T10:00:00',
                        end: '2023-05-16T10:30:00',
                        extendedProps: {
                            type: 'default',
                            location: 'Clínica Veterinaria',
                            description: 'Revisión periódica para Max'
                        }
                    },
                    {
                        id: '2',
                        title: 'URGENTE: Vacunación (Carlos Pérez)',
                        start: '2023-05-16T11:30:00',
                        end: '2023-05-16T12:00:00',
                        backgroundColor: '#ff9800',
                        borderColor: '#e65100',
                        extendedProps: {
                            type: 'urgent',
                            location: 'Clínica Veterinaria',
                            description: 'Vacuna antirrábica'
                        }
                    },
                    {
                        id: '3',
                        title: 'Cirugía completada (Ana Martínez)',
                        start: '2023-05-17T09:00:00',
                        end: '2023-05-17T11:00:00',
                        backgroundColor: '#4caf50',
                        borderColor: '#2e7d32',
                        extendedProps: {
                            type: 'completed',
                            location: 'Clínica Veterinaria - Quirófano',
                            description: 'Cirugía de fractura en pata derecha'
                        }
                    },
                    {
                        id: '4',
                        title: 'Control cancelada (Pedro Sánchez)',
                        start: '2023-05-18T15:00:00',
                        end: '2023-05-18T15:30:00',
                        backgroundColor: '#f44336',
                        borderColor: '#b71c1c',
                        textDecoration: 'line-through',
                        extendedProps: {
                            type: 'cancelled',
                            location: 'Clínica Veterinaria',
                            description: 'Control post-operatorio cancelado'
                        }
                    }
                ],
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                locale: 'es',
                height: '100%',
                expandRows: true,
                nowIndicator: true,
                businessHours: {
                    daysOfWeek: [1, 2, 3, 4, 5],
                    startTime: '08:00',
                    endTime: '20:00',
                },
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                firstDay: 1, // Lunes como primer día
                eventClick: function(info) {
                    const event = info.event;
                    alert('Evento: ' + event.title);
                    
                    // Notificar a Java si está disponible
                    if (window.javaConnector) {
                        window.javaConnector.processEvent('click', JSON.stringify({
                            id: event.id,
                            title: event.title,
                            start: event.startStr,
                            end: event.endStr,
                            description: event.extendedProps.description || '',
                            location: event.extendedProps.location || '',
                            type: event.extendedProps.type || 'default'
                        }));
                    }
                },
                dateClick: function(info) {
                    alert('Fecha seleccionada: ' + info.dateStr);
                    // Aquí podríamos abrir un modal para crear un nuevo evento
                },
                eventClassNames: function(arg) {
                    // Añadir clases según el tipo de evento
                    const type = arg.event.extendedProps.type;
                    if (type === 'urgent') return ['urgent-event'];
                    if (type === 'completed') return ['completed-event'];
                    if (type === 'cancelled') return ['cancelled-event'];
                    return ['normal-event'];
                }
            });
            
            calendar.render();
            
            // Configurar API para comunicación con Java
            window.calendarApi = {
                // Toggle del modo oscuro
                toggleDarkMode: function(isDark) {
                    document.body.className = isDark ? 'dark-theme' : '';
                },
                
                // Actualizar todos los eventos
                updateEvents: function(newEventsJson) {
                    try {
                        let newEvents;
                        if (typeof newEventsJson === 'string') {
                            newEvents = JSON.parse(newEventsJson);
                        } else {
                            newEvents = newEventsJson;
                        }
                        
                        if (!Array.isArray(newEvents)) {
                            newEvents = newEvents ? [newEvents] : [];
                        }
                        
                        // Limpiar eventos existentes
                        calendar.removeAllEvents();
                        
                        // Añadir nuevos eventos
                        calendar.addEventSource(newEvents);
                        
                        console.log('Eventos actualizados:', newEvents.length);
                    } catch (error) {
                        console.error('Error updating events:', error);
                    }
                },
                
                // Ir a hoy
                goToToday: function() {
                    calendar.today();
                },
                
                // Ir a una fecha específica
                goToDate: function(dateStr) {
                    calendar.gotoDate(dateStr);
                },
                
                // Cambiar vista
                changeView: function(viewName) {
                    calendar.changeView(viewName);
                },
                
                // Crear nuevo evento
                createNewEvent: function() {
                    alert('Nueva cita - Implementación pendiente');
                },
                
                // Refrescar calendario
                refreshCalendar: function() {
                    if (window.javaConnector) {
                        window.javaConnector.processEvent('refresh', JSON.stringify({
                            requestType: 'userAppointments',
                            timestamp: new Date().getTime()
                        }));
                    } else {
                        calendar.refetchEvents();
                    }
                }
            };
            
            // Configurar botones
            document.getElementById('btn-today').addEventListener('click', function() {
                window.calendarApi.goToToday();
            });
            
            document.getElementById('btn-refresh').addEventListener('click', function() {
                window.calendarApi.refreshCalendar();
            });
            
            document.getElementById('btn-new-event').addEventListener('click', function() {
                window.calendarApi.createNewEvent();
            });
            
            document.getElementById('btn-print').addEventListener('click', function() {
                window.print();
            });
            
            // Configurar filtros
            const filterNormal = document.getElementById('filter-normal');
            const filterUrgent = document.getElementById('filter-urgent');
            const filterCompleted = document.getElementById('filter-completed');
            const filterCancelled = document.getElementById('filter-cancelled');
            
            function applyFilters() {
                const events = calendar.getEvents();
                
                events.forEach(event => {
                    const type = event.extendedProps.type || 'default';
                    
                    let visible = true;
                    if (type === 'default' && !filterNormal.checked) visible = false;
                    if (type === 'urgent' && !filterUrgent.checked) visible = false;
                    if (type === 'completed' && !filterCompleted.checked) visible = false;
                    if (type === 'cancelled' && !filterCancelled.checked) visible = false;
                    
                    if (visible) {
                        event.setProp('display', 'auto');
                    } else {
                        event.setProp('display', 'none');
                    }
                });
            }
            
            filterNormal.addEventListener('change', applyFilters);
            filterUrgent.addEventListener('change', applyFilters);
            filterCompleted.addEventListener('change', applyFilters);
            filterCancelled.addEventListener('change', applyFilters);
        });
    </script>
</body>
</html> 